<?xml version="1.0" encoding="utf-8"?>
<Window
    x:Class="VoxelLauncher.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:converters="using:VoxelLauncher.Converters"
    xmlns:vm="using:VoxelLauncher.ViewModels"
    xmlns:app="using:VoxelLauncher"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <Window.SystemBackdrop>
        <DesktopAcrylicBackdrop />
    </Window.SystemBackdrop>

    <Grid>
        <Grid x:Name="RootGrid" DataContext="{Binding}">
            <Grid.Resources>
                <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
            </Grid.Resources>

            <Grid.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                    <GradientStop Color="#FF1A1A1A" Offset="0.00"/>
                    <GradientStop Color="#FF1B1B1B" Offset="0.08"/>
                    <GradientStop Color="#FF1D1D1D" Offset="0.16"/>
                    <GradientStop Color="#FF1F1F1F" Offset="0.24"/>
                    <GradientStop Color="#FF212121" Offset="0.32"/>
                    <GradientStop Color="#FF232323" Offset="0.40"/>
                    <GradientStop Color="#FF262626" Offset="0.50"/>
                    <GradientStop Color="#FF282828" Offset="0.60"/>
                    <GradientStop Color="#FF252525" Offset="0.70"/>
                    <GradientStop Color="#FF222222" Offset="0.80"/>
                    <GradientStop Color="#FF1E1E1E" Offset="0.90"/>
                    <GradientStop Color="#FF1C1C1C" Offset="1.00"/>
                </LinearGradientBrush>

            </Grid.Background>

            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <!-- Title Bar -->
                <RowDefinition Height="*" />
                <!-- Main Content -->
                <RowDefinition Height="Auto" />
                <!-- Bottom Bar -->
                <RowDefinition Height="80" />
                <!-- Button Area -->
            </Grid.RowDefinitions>

            <!-- ==================== CUSTOM TITLE BAR ==================== -->
            <Grid x:Name="CustomTitleBar"
              Grid.Row="0"
              Height="36"
              Background="Transparent">
                <TextBlock x:Name="TitleText"
                       Text="Voxel Launcher"
                       Foreground="#FF2E8B57"
                       FontSize="14"
                       FontWeight="SemiBold"
                       VerticalAlignment="Center"
                       Margin="12,0,0,0" />
            </Grid>

            <!-- ==================== MAIN FRAME ==================== -->
            <Frame x:Name="MainFrame"
               Grid.Row="1"
               NavigationFailed="MainFrame_NavigationFailed" />

            <!-- ==================== BOTTOM BAR ==================== -->
            <Border Grid.Row="2"
                Background="#FF252525"
                BorderBrush="#FF3A3A3A"
                BorderThickness="0,1,0,0"
                Padding="5,4"
                    Canvas.ZIndex="100">
                <!-- Tăng padding để thanh không bị ép -->

                <ProgressBar x:Name="StartupLoadingProgressBar"
                             Value="{Binding StartupProgress}"
                             Visibility="{Binding IsInstalling, Converter={StaticResource BoolToVisibilityConverter}}"
                             Height="8"
                             CornerRadius="2"
                             Background="#FF2A2A2A"
                             Foreground="#22C55E"
                             VerticalAlignment="Center"
                             Margin="0,4" />
            </Border>

            <!-- ==================== THANH DƯỚI CÙNG ==================== -->
            <Border Grid.Row="3"
                    Height="80"
                    VerticalAlignment="Bottom"
                    Background="#FF252525"
                    BorderBrush="#FF3A3A3A"
                    BorderThickness="0,1,0,0"
                    Canvas.ZIndex="99" />

            <!-- ==================== NÚT MENU ==================== -->
            <Grid Grid.Row="2"
                  Grid.RowSpan="2"
                  HorizontalAlignment="Left"
                  VerticalAlignment="Bottom"
                  Margin="30,0,0,30"
                  Canvas.ZIndex="101">
                <Button x:Name="MenuToggleButton"
                    Width="40" Height="40"
                    Foreground="White"
                    Background="#FF3A3A3A"
                    BorderBrush="#FF555555"
                    BorderThickness="1"
                    Click="MenuToggleButton_Click"
                    Padding="0">
                    <FontIcon Glyph="&#xE71D;"
                          FontFamily="Segoe MDL2 Assets"
                          FontSize="16"
                          Foreground="White"/>
                </Button>
            </Grid>

            <!-- ==================== NÚT NỔI LÊN ==================== -->
            <StackPanel Grid.Row="2" 
                    Grid.RowSpan="2"
                    Orientation="Horizontal"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Bottom"
                    Margin="0,0,0,20"
                    Spacing="24"
                    Canvas.ZIndex="101">

                <Button x:Name="ChangelogButton"
                    Content="Changelog"
                    Tag="ChangelogPage"
                    HorizontalAlignment="Left"
                    Click="TabButton_Click"
                    Foreground="White"
                    Background="#FF3A3A3A"
                    BorderBrush="#FF555555"
                    Padding="16,8" />

                <!-- NÚT PLAY -->
                <Button x:Name="PlayButton"
                    Content="Play"
                    Tag="ClientPage"
                    Style="{StaticResource AccentButtonStyle}"
                    FontSize="20"
                    FontWeight="SemiBold"
                    Padding="40,16"
                    Margin="0,0,0,20"
                    MinWidth="180"
                    Click="TabButton_Click" />

                <!-- NÚT SETTINGS -->
                <Button x:Name="SettingsButton"
                    Content="Settings"
                    Tag="Settings"
                    Foreground="White"
                    Background="#FF3A3A3A"
                    BorderBrush="#FF555555"
                    Padding="16,8"
                    Click="TabButton_Click" />

            </StackPanel>

            <!-- ==================== NOTIFICATION BUTTON ==================== -->
            <Grid Grid.Row="0" Grid.RowSpan="4">

                <Button x:Name="NotificationButton"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Top"
                        Margin="20,0,250,0"
                        Background="Transparent"
                        BorderThickness="0"
                        Padding="5"
                        CornerRadius="22"
                        Click="NotificationButton_Click"
                        Visibility="{Binding PendingUpdateCount, Converter={StaticResource IntToVisibilityConverter}}"
                        ToolTipService.ToolTip="Cập nhật bị bỏ qua">
                    <Grid>
                        <FontIcon Glyph="&#xF2A3;" FontSize="28" Foreground="White"/>
                        <!-- Badge số -->
                        <Border x:Name="NotificationBadge"
                                Background="#EF4444"
                                CornerRadius="10"
                                MinWidth="18" Height="18"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Top"
                                Margin="0,-4,-4,0"
                                Padding="4,2"
                                Visibility="{Binding PendingUpdateCount, Converter={StaticResource IntToVisibilityConverter}}"
                                BorderBrush="White" BorderThickness="2">
                            <TextBlock Text="{Binding PendingUpdateCount}"
                                       Foreground="White"
                                       FontSize="10"
                                       FontWeight="SemiBold"
                                       HorizontalAlignment="Center"/>
                        </Border>
                    </Grid>
                </Button>
            </Grid>

            <!-- ==================== ACCOUNT BUTTON ==================== -->
            <Grid Grid.Row="0" Grid.RowSpan="4">

                <Button x:Name="AccountButton"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Top"
                    Margin="0,0,130,0"
                    Background="Transparent"
                    BorderThickness="0"
                    Padding="5"
                    CornerRadius="18">

                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Border x:Name="UserAvatarContainer"
                                Width="28" Height="28"
                                CornerRadius="4" 
                                BorderThickness="2"
                                BorderBrush="{ThemeResource SystemAccentColor}"
                                Background="#FF2D2D2D">
                            <Image x:Name="UserAvatar" Stretch="UniformToFill" />
                        </Border>
                        <TextBlock x:Name="UserNameText"
                                   Text="Đăng nhập"
                                   Foreground="White"
                                   FontWeight="SemiBold"
                                   VerticalAlignment="Center"
                                   Margin="4,0,0,0"/>
                    </StackPanel>

                    <Button.Flyout>
                        <MenuFlyout Placement="BottomEdgeAlignedRight">

                            <MenuFlyoutItem Text="Tài khoản" Click="Account_Click">
                                <MenuFlyoutItem.Icon>
                                    <FontIcon Glyph="&#xE77B;" FontFamily="Segoe MDL2 Assets" />
                                </MenuFlyoutItem.Icon>
                            </MenuFlyoutItem>

                            <MenuFlyoutSeparator/>
                            <MenuFlyoutItem Text="Đổi tài khoản" Click="ChangeAccount_Click">
                                <MenuFlyoutItem.Icon>
                                    <FontIcon Glyph="&#xE748;" FontFamily="Segoe MDL2 Assets" />
                                </MenuFlyoutItem.Icon>
                            </MenuFlyoutItem>

                            <MenuFlyoutItem Text="Đăng xuất" Click="Logout_Click">
                                <MenuFlyoutItem.Icon>
                                    <FontIcon Glyph="&#xF3B1;" FontFamily="Segoe MDL2 Assets" />
                                </MenuFlyoutItem.Icon>
                            </MenuFlyoutItem>

                            <MenuFlyoutSeparator/>
                            <MenuFlyoutItem Text="Thông tin" Click="Info_Click">
                                <MenuFlyoutItem.Icon>
                                    <FontIcon Glyph="&#xE946;" FontFamily="Segoe MDL2 Assets" />
                                </MenuFlyoutItem.Icon>
                            </MenuFlyoutItem>
                        </MenuFlyout>
                    </Button.Flyout>

                </Button>
            </Grid>

            <!-- ==================== SLIDE SIDEBAR ==================== -->
            <Grid x:Name="SidebarOverlay"
              Grid.Row="0" Grid.RowSpan="4"
              Background="#CC000000"
              Visibility="Collapsed"
              Tapped="SidebarOverlay_Tapped"
              Canvas.ZIndex="103">
                <Grid x:Name="SidebarPanel"
                  Width="260"
                  HorizontalAlignment="Left"
                  Background="#FF1E1E1E"
                  BorderBrush="#FF3A3A3A"
                  BorderThickness="0,0,1,0"
                  RenderTransform="{x:Bind SidebarTransform}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <!-- Header -->
                        <RowDefinition Height="*"/>
                        <!-- Menu items -->
                        <RowDefinition Height="Auto"/>
                        <!-- Footer (optional) -->
                    </Grid.RowDefinitions>

                    <!-- Header -->
                    <Border Grid.Row="0" Background="#FF2A2A2A" Padding="16,12">
                        <TextBlock Text="Voxel Launcher"
                                   FontSize="16"
                                   FontWeight="SemiBold"
                                   Foreground="#FF2E8B57"/>
                    </Border>

                    <!-- Menu Items -->
                    <StackPanel Grid.Row="1" Spacing="4" Margin="8,12">
                        <Button Content="Thông tin"
                                Tag="InfoPage"
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Left"
                                Padding="12,10"
                                Click="SidebarItem_Click"
                                Background="Transparent"
                                BorderThickness="0"
                                Foreground="White">
                            <Button.ContentTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Spacing="10">
                                        <FontIcon Glyph="&#xE946;" FontSize="16"/>
                                        <TextBlock Text="{Binding}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </Button.ContentTemplate>
                        </Button>

                        <Button Content="Mods"
                                Tag="ModsPage"
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Left"
                                Padding="12,10"
                                Click="SidebarItem_Click"
                                Background="Transparent"
                                BorderThickness="0"
                                Foreground="White">
                            <Button.ContentTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Spacing="10">
                                        <FontIcon Glyph="&#xE8C8;" FontSize="16"/>
                                        <TextBlock Text="{Binding}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </Button.ContentTemplate>
                        </Button>

                        <Button Content="Servers"
                                Tag="ServerListPage"
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Left"
                                Padding="12,10"
                                Click="SidebarItem_Click"
                                Background="Transparent"
                                BorderThickness="0"
                                Foreground="White">
                            <Button.ContentTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Spacing="10">
                                        <FontIcon Glyph="&#xE8CE;" FontSize="16"/>
                                        <TextBlock Text="{Binding}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </Button.ContentTemplate>
                        </Button>

                        <Button Content="Đối tác"
                                Tag="PartnerPage"
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Left"
                                Padding="12,10"
                                Click="SidebarItem_Click"
                                Background="Transparent"
                                BorderThickness="0"
                                Foreground="White">
                            <Button.ContentTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Spacing="10">
                                        <FontIcon Glyph="&#xE716;" FontSize="16"/>
                                        <TextBlock Text="{Binding}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </Button.ContentTemplate>
                        </Button>

                        <!-- Thêm các mục khác ở đây -->
                    </StackPanel>

                    <!-- Footer (ví dụ: phiên bản) -->
                    <TextBlock Grid.Row="2"
                               Text="v1.0.0"
                               Foreground="#FF777777"
                               FontSize="12"
                               HorizontalAlignment="Center"
                               Margin="0,8"/>
                </Grid>
            </Grid>

            <!-- ==================== LOADING OVERLAY ==================== -->
            <Grid x:Name="LoadingOverlay"
      Background="#000000"
      Visibility="Collapsed"
      Grid.RowSpan="4"
      Grid.Row="0"
      Canvas.ZIndex="999">

                <!-- VIDEO LAYER - FULL MÀN HÌNH -->
                <MediaPlayerElement x:Name="LoadingVideoPlayer"
                        Source="ms-appx:///Assets/loadding/loading_video.mkv"
                        AreTransportControlsEnabled="False"
                        Stretch="UniformToFill"
                        AutoPlay="False"
                        HorizontalAlignment="Stretch"
                        VerticalAlignment="Stretch"
                        Opacity="0"
                        Visibility="Collapsed" />

                <!-- GIF LAYER - FULL MÀN HÌNH -->
                <Image x:Name="LoadingGifImage"
           Source="ms-appx:///Assets/loadding/loadding_microsoft.gif"
           Stretch="UniformToFill"
           HorizontalAlignment="Center"
           VerticalAlignment="Center"
           Opacity="0"
           Visibility="Collapsed" />

                <!-- CONTENT LAYER - GIỮA MÀN HÌNH -->
                <StackPanel x:Name="LoadingContent"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Spacing="20"
                        Opacity="0"
                        Visibility="Collapsed">
                    <Image Source="ms-appx:///Assets/logo/serve_logor.png" Width="120" Height="120"/>
                    <TextBlock Text="Voxel Launcher" FontSize="24" FontWeight="SemiBold" Foreground="White" HorizontalAlignment="Center"/>
                    <ProgressBar x:Name="LoadingProgressBar" IsIndeterminate="True" Width="280" Height="6" Foreground="#4F46E5"/>
                    <TextBlock x:Name="LoadingText" Text="Đang tải dữ liệu..." Foreground="#9CA3AF" FontSize="14" HorizontalAlignment="Center"/>
                </StackPanel>
            </Grid>

            <!-- ==================== UPDATE PROGRESS OVERLAY ==================== -->
            <Grid x:Name="UpdateProgressOverlay" 
                  Visibility="Collapsed" 
                  Background="#80000000"
                  HorizontalAlignment="Stretch"
                  VerticalAlignment="Stretch"
                  Grid.RowSpan="4"
                    Grid.Row="0"
                  Canvas.ZIndex="1000">
                <Border Background="{ThemeResource ApplicationPageBackgroundThemeBrush}"
                        CornerRadius="12"
                        Padding="24"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        MinWidth="360"
                        MaxWidth="500">
                    <StackPanel Spacing="12">
                        <TextBlock Text="Đang cập nhật launcher..." 
                       FontWeight="SemiBold" 
                       FontSize="16" 
                       HorizontalAlignment="Center"/>
                        <ProgressBar x:Name="UpdateProgressBar"
                         IsIndeterminate="True"
                         Height="6"
                         Foreground="#10B981"
                         Background="#333333"
                         CornerRadius="3"/>
                        <TextBlock Text="{x:Bind ViewModel.UpdateStatus, Mode=OneWay}"
                                   FontSize="12"
                                   Foreground="{ThemeResource SystemAccentColor}"
                                   HorizontalAlignment="Center"
                                   TextWrapping="Wrap"/>
                        <Button x:Name="CancelUpdateButton"
                                Content="Hủy"
                                Visibility="Collapsed"
                                Click="CancelUpdateButton_Click"
                                HorizontalAlignment="Center"
                                Margin="0,0,16,16"
                                Style="{StaticResource AccentButtonStyle}"/>
                    </StackPanel>
                </Border>
            </Grid>
        </Grid>

        <!-- ==================== NOTIFICATION OVERLAY ==================== -->
        <Grid x:Name="NotificationOverlay"
              Background="#CC000000"
              Visibility="Collapsed"
              HorizontalAlignment="Stretch"
              VerticalAlignment="Stretch"
              Canvas.ZIndex="1000"
              Tapped="WelcomeOverlay_Tapped">
            <Border Background="#FF1E1E1E"
                    CornerRadius="12"
                    Padding="16"
                    MaxWidth="600"
                    MaxHeight="500"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
                <StackPanel Spacing="12">
                    <TextBlock Text="Bản cập nhật bị bỏ qua" FontWeight="SemiBold" FontSize="24" Foreground="White"/>
                    <ScrollViewer x:Name="NotificationScroll"
                                  VerticalScrollBarVisibility="Auto"
                                  MaxHeight="400">
                        <StackPanel x:Name="NotificationStack" Spacing="8"/>
                    </ScrollViewer>
                    <Button Content="Đóng" HorizontalAlignment="Right" Click="CloseNotificationOverlay_Click"/>
                </StackPanel>
            </Border>
        </Grid>
        
        <!--==================== Notify ====================-->
        <Grid x:Name="notify">

            <!-- WELCOME POPUP -->
            <Border x:Name="WelcomeOverlay"
                    Background="#CC000000"
                    Visibility="Collapsed"
                    HorizontalAlignment="Stretch"
                    VerticalAlignment="Stretch"
                    Tapped="WelcomeOverlay_Tapped">
                <!-- Click nền để đóng -->

                <!-- Popup chính (nằm giữa) -->
                <Border Background="#1A1A1A"
                CornerRadius="16"
                BorderBrush="#333333"
                BorderThickness="1"
                MaxWidth="600"
                MaxHeight="500"
                Padding="24"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                IsHitTestVisible="False">
                    <!-- Không chặn click nền -->

                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Tiêu đề -->
                        <TextBlock Grid.Row="0"
                           Text="Chào mừng đến với Voxel Launcher!"
                           FontSize="20"
                           FontWeight="SemiBold"
                           Foreground="#10B981"
                           Margin="0,0,0,16"
                           HorizontalAlignment="Center"/>

                        <!-- Nội dung scroll -->
                        <ScrollViewer Grid.Row="1"
                              VerticalScrollBarVisibility="Auto"
                              Margin="0,0,0,16">
                            <TextBlock x:Name="WelcomeContentText"
                               TextWrapping="Wrap"
                               Foreground="#E5E7EB"
                               FontSize="14"
                               LineHeight="22"/>
                        </ScrollViewer>

                        <!-- Nút đóng -->
                        <Button Grid.Row="2"
                        Content="Đã hiểu, không hiện lại"
                        HorizontalAlignment="Center"
                        Style="{StaticResource AccentButtonStyle}"
                        Click="CloseWelcome_Click"
                        IsHitTestVisible="True"/>
                    </Grid>
                </Border>
            </Border>
        </Grid>

        <!--==================== CHAT GUIDE OVERLAY ====================-->
        <Grid x:Name="ChatGuideOverlay"
              Visibility="Collapsed"
              HorizontalAlignment="Right"
              VerticalAlignment="Bottom"
              Margin="0,0,190,50"
              Canvas.ZIndex="500"
              IsHitTestVisible="False">
            <!-- để không chặn tương tác với phần khác -->


            <!-- Tooltip (bong bóng thoại) -->
            <Border x:Name="ChatTooltip"
                    Background="#CC1E1E1E"
                    CornerRadius="16"
                    Padding="12,8"
                    MaxWidth="280"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Bottom"
                    Margin="60,0,0,60"
                    Opacity="0"
                    Visibility="Collapsed">
                <TextBlock x:Name="ChatTooltipText"
                           Text="Chào mừng bạn đến với Voxel Launcher!"
                           Foreground="White"
                           FontSize="13"
                           TextWrapping="Wrap"
                           FontWeight="SemiBold"/>
            </Border>

            <!-- GIF Nhân vật -->
            <Image x:Name="ChatGuideGif"
                   Source="ms-appx:///Assets/gif/ally.gif"
                   Stretch="Uniform"
                   Width="100"
                   Height="100"
                   HorizontalAlignment="Left"
                   VerticalAlignment="Bottom"
                   Opacity="0"
                   Visibility="Collapsed"/>
        </Grid>
    </Grid>
</Window>

