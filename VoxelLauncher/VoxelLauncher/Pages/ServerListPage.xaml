<Page
    x:Class="VoxelLauncher.Pages.ServerListPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:VoxelLauncher.Models"
    xmlns:converters="using:VoxelLauncher.Converters"
    mc:Ignorable="d">

    <Page.Resources>
        <!-- Converter  -->
        <converters:OnlineStatusColorConverter x:Key="OnlineStatusColorConverter"/>

        <!-- ListViewItem -->
        <Style x:Key="ServerCardContainerStyle" TargetType="ListViewItem">
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="0,6"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListViewItem">
                        <ContentPresenter x:Name="ContentPresenter"
                                          Content="{TemplateBinding Content}"
                                          ContentTemplate="{TemplateBinding ContentTemplate}"
                                          HorizontalAlignment="Stretch"/>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- DataTemplate -->
        <DataTemplate x:Key="ServerDataTemplate" x:DataType="models:Server">
            <Border x:Name="ServerCard"
                    Background="#FF252525"
                    CornerRadius="12"
                    Padding="14"
                    Height="110"
                    Margin="0,4"
                    BorderThickness="1"
                    BorderBrush="#FF3A3A3A"
                    RenderTransformOrigin="0.5,0.5"
                    Tapped="ServerCard_Tapped">

                <!-- Scale -->
                <Border.RenderTransform>
                    <ScaleTransform x:Name="ScaleTransform"/>
                </Border.RenderTransform>

                <!-- Nội dung -->
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="80"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="130"/>
                        <ColumnDefinition Width="80"/>
                    </Grid.ColumnDefinitions>

                    <!-- Ảnh -->
                    <Border Grid.Column="0" CornerRadius="8" Background="#FF2D2D2D" BorderBrush="#FF404040" BorderThickness="1">
                        <Image Source="{x:Bind ImageUrl, Converter={StaticResource ImageSourceConverter}, TargetNullValue='ms-appx:///Assets/Icons/vanilla.png'}"
                               Stretch="UniformToFill"/>
                    </Border>

                    <!-- Thông tin -->
                    <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="14,0">
                        <TextBlock Text="{x:Bind ServerName}" FontWeight="SemiBold" Foreground="White" FontSize="17" TextTrimming="CharacterEllipsis"/>
                        <TextBlock Text="{x:Bind IpPC}" Foreground="#FF9CA3AF" FontSize="12.5" Margin="0,2"/>
                        <TextBlock Text="{x:Bind IpPE}" Foreground="#FF78716C" FontSize="11" Margin="0,1"/>
                        <TextBlock Text="{x:Bind Tags}" Foreground="#FF4F46E5" FontSize="11" FontStyle="Italic"/>
                    </StackPanel>

                    <!-- Trạng thái -->
                    <StackPanel Grid.Column="2" VerticalAlignment="Center" HorizontalAlignment="Center">
                        <TextBlock Text="{x:Bind OnlineStatus}"
                                   Foreground="{x:Bind CurrentUsers, Converter={StaticResource OnlineStatusColorConverter}}"
                                   FontWeight="SemiBold" FontSize="13"/>
                        <TextBlock Text="{x:Bind PlayerText}" Foreground="#FF22C55E" FontSize="14" HorizontalAlignment="Center" Margin="0,2"/>
                        <ProgressBar Value="{x:Bind OnlinePercentage}" Maximum="100" Height="5" Margin="0,6"
                                     Foreground="#FF22C55E" Background="#FF333333" CornerRadius="2"/>
                    </StackPanel>

                    <!-- Ping -->
                    <TextBlock Grid.Column="3" Text="~45ms" Foreground="#FF9CA3AF" FontSize="12"
                               VerticalAlignment="Center" HorizontalAlignment="Center" FontWeight="Medium"/>
                </Grid>

                <!-- Visual States -->
                <VisualStateManager.VisualStateGroups>
                    <VisualStateGroup x:Name="CommonStates">
                        <VisualState x:Name="Normal">
                            <Storyboard>
                                <DoubleAnimation Storyboard.TargetName="ScaleTransform"
                                                 Storyboard.TargetProperty="ScaleX" To="1" Duration="0:0:0.2"/>
                                <DoubleAnimation Storyboard.TargetName="ScaleTransform"
                                                 Storyboard.TargetProperty="ScaleY" To="1" Duration="0:0:0.2"/>
                                <DoubleAnimation Storyboard.TargetName="ServerCard"
                                                 Storyboard.TargetProperty="BorderThickness.Left" To="1" Duration="0:0:0.2"/>
                                <DoubleAnimation Storyboard.TargetName="ServerCard"
                                                 Storyboard.TargetProperty="BorderThickness.Top" To="1" Duration="0:0:0.2"/>
                                <DoubleAnimation Storyboard.TargetName="ServerCard"
                                                 Storyboard.TargetProperty="BorderThickness.Right" To="1" Duration="0:0:0.2"/>
                                <DoubleAnimation Storyboard.TargetName="ServerCard"
                                                 Storyboard.TargetProperty="BorderThickness.Bottom" To="1" Duration="0:0:0.2"/>
                                <ColorAnimation Storyboard.TargetName="ServerCard"
                                                Storyboard.TargetProperty="(Border.Background).(SolidColorBrush.Color)"
                                                To="#FF252525" Duration="0:0:0.2"/>
                                <ColorAnimation Storyboard.TargetName="ServerCard"
                                                Storyboard.TargetProperty="(Border.BorderBrush).(SolidColorBrush.Color)"
                                                To="#FF3A3A3A" Duration="0:0:0.2"/>
                            </Storyboard>
                        </VisualState>

                        <VisualState x:Name="PointerOver">
                            <Storyboard>
                                <!-- Scale -->
                                <DoubleAnimation Storyboard.TargetName="ScaleTransform"
                                                 Storyboard.TargetProperty="ScaleX" To="1.025" Duration="0:0:0.2"/>
                                <DoubleAnimation Storyboard.TargetName="ScaleTransform"
                                                 Storyboard.TargetProperty="ScaleY" To="1.025" Duration="0:0:0.2"/>

                                <!-- Viền dày + màu tím -->
                                <DoubleAnimation Storyboard.TargetName="ServerCard"
                                                 Storyboard.TargetProperty="BorderThickness.Left" To="1.5" Duration="0:0:0.2"/>
                                <DoubleAnimation Storyboard.TargetName="ServerCard"
                                                 Storyboard.TargetProperty="BorderThickness.Top" To="1.5" Duration="0:0:0.2"/>
                                <DoubleAnimation Storyboard.TargetName="ServerCard"
                                                 Storyboard.TargetProperty="BorderThickness.Right" To="1.5" Duration="0:0:0.2"/>
                                <DoubleAnimation Storyboard.TargetName="ServerCard"
                                                 Storyboard.TargetProperty="BorderThickness.Bottom" To="1.5" Duration="0:0:0.2"/>

                                <!-- Nền -->
                                <ColorAnimation Storyboard.TargetName="ServerCard"
                                                Storyboard.TargetProperty="(Border.Background).(SolidColorBrush.Color)"
                                                To="#FF2A2A2A" Duration="0:0:0.2"/>

                                <!-- Viền tím phát sáng -->
                                <ColorAnimation Storyboard.TargetName="ServerCard"
                                                Storyboard.TargetProperty="(Border.BorderBrush).(SolidColorBrush.Color)"
                                                To="#FF4F46E5" Duration="0:0:0.2"/>
                            </Storyboard>
                        </VisualState>
                    </VisualStateGroup>
                </VisualStateManager.VisualStateGroups>
            </Border>
        </DataTemplate>
    </Page.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Tiêu đề -->
        <TextBlock Text="Danh sách Server"
                   Grid.Row="0"
                   FontSize="26"
                   FontWeight="SemiBold"
                   Foreground="#FF2E8B57"
                   Margin="24,16,0,8"
                   FontFamily="Segoe UI"/>

        <Grid Grid.Row="1" Margin="24,15,24,8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Ô tìm kiếm -->
            <TextBox x:Name="SearchBox"
                     PlaceholderText="Tìm kiếm server theo tên hoặc tag..."
                     FontSize="15"
                     Padding="12,10"
                     CornerRadius="8"
                     Background="#FF252525"
                     BorderBrush="#FF404040"
                     BorderThickness="1"
                     TextChanged="SearchBox_TextChanged"/>

            <!-- Icon tìm kiếm -->
            <FontIcon Grid.Column="1"
                      Glyph="&#xE721;"
                      FontFamily="Segoe MDL2 Assets"
                      Foreground="#FF9CA3AF"
                      Margin="12,0,0,0"
                      VerticalAlignment="Center"/>
        </Grid>
        <!-- Danh sách server -->
        <ScrollViewer Grid.Row="2">
            <ListView x:Name="ServerListView"
          ItemsSource="{x:Bind Servers}"
          SelectionMode="None"
          IsItemClickEnabled="True"
          ItemClick="ServerListView_ItemClick"
          ItemTemplate="{StaticResource ServerDataTemplate}"
          ItemContainerStyle="{StaticResource ServerCardContainerStyle}"
          Margin="24,0"
          ScrollViewer.VerticalScrollBarVisibility="Auto"
          Background="Transparent">
                <ListView.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Spacing="8"/>
                    </ItemsPanelTemplate>
                </ListView.ItemsPanel>
            </ListView>
        </ScrollViewer>
        <!-- Loading -->
        <StackPanel Grid.Row="2"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Visibility="{x:Bind IsLoading, Mode=OneWay}"
                    Spacing="12">
            <ProgressRing IsActive="True" Foreground="#FF2E8B57" Width="48" Height="48"/>
            <TextBlock Text="Đang tải server..."
                       Foreground="#FF9CA3AF"
                       FontSize="14"
                       HorizontalAlignment="Center"/>
        </StackPanel>

        <!-- Error -->
        <TextBlock Grid.Row="3"
                   x:Name="ErrorText"
                   Text="Không tải được danh sách server."
                   Foreground="#FFF87171"
                   HorizontalAlignment="Center"
                   Margin="24,12"
                   FontSize="14"
                   Visibility="Collapsed"/>
    </Grid>
</Page>